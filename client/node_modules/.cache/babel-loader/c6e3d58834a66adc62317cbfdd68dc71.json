{"ast":null,"code":"/**\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * \n * @emails oncall+relay\n * @format\n */\n// flowlint ambiguous-object-type:error\n'use strict';\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _objectSpread2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectSpread2\"));\n\nvar OperationExecutor = require('./OperationExecutor');\n\nvar RelayDefaultHandlerProvider = require('../handlers/RelayDefaultHandlerProvider');\n\nvar RelayFeatureFlags = require('../util/RelayFeatureFlags');\n\nvar RelayObservable = require('../network/RelayObservable');\n\nvar RelayOperationTracker = require('../store/RelayOperationTracker');\n\nvar RelayPublishQueue = require('./RelayPublishQueue');\n\nvar RelayRecordSource = require('./RelayRecordSource');\n\nvar defaultGetDataID = require('./defaultGetDataID');\n\nvar defaultRequiredFieldLogger = require('./defaultRequiredFieldLogger');\n\nvar generateID = require('../util/generateID');\n\nvar invariant = require('invariant');\n\nvar RelayModernEnvironment = /*#__PURE__*/function () {\n  function RelayModernEnvironment(config) {\n    var _this = this;\n\n    var _config$log, _config$requiredField, _config$UNSTABLE_defa, _config$getDataID, _config$handlerProvid, _config$scheduler, _config$isServer, _config$operationTrac;\n\n    this.configName = config.configName;\n    this._treatMissingFieldsAsNull = config.treatMissingFieldsAsNull === true;\n    var operationLoader = config.operationLoader;\n    var reactFlightPayloadDeserializer = config.reactFlightPayloadDeserializer;\n    var reactFlightServerErrorHandler = config.reactFlightServerErrorHandler;\n\n    if (process.env.NODE_ENV !== \"production\") {\n      if (operationLoader != null) {\n        !(typeof operationLoader === 'object' && typeof operationLoader.get === 'function' && typeof operationLoader.load === 'function') ? process.env.NODE_ENV !== \"production\" ? invariant(false, 'RelayModernEnvironment: Expected `operationLoader` to be an object ' + 'with get() and load() functions, got `%s`.', operationLoader) : invariant(false) : void 0;\n      }\n\n      if (reactFlightPayloadDeserializer != null) {\n        !(typeof reactFlightPayloadDeserializer === 'function') ? process.env.NODE_ENV !== \"production\" ? invariant(false, 'RelayModernEnvironment: Expected `reactFlightPayloadDeserializer` ' + ' to be a function, got `%s`.', reactFlightPayloadDeserializer) : invariant(false) : void 0;\n      }\n    }\n\n    this.__log = (_config$log = config.log) !== null && _config$log !== void 0 ? _config$log : emptyFunction;\n    this.requiredFieldLogger = (_config$requiredField = config.requiredFieldLogger) !== null && _config$requiredField !== void 0 ? _config$requiredField : defaultRequiredFieldLogger;\n    this._defaultRenderPolicy = ((_config$UNSTABLE_defa = config.UNSTABLE_defaultRenderPolicy) !== null && _config$UNSTABLE_defa !== void 0 ? _config$UNSTABLE_defa : RelayFeatureFlags.ENABLE_PARTIAL_RENDERING_DEFAULT === true) ? 'partial' : 'full';\n    this._operationLoader = operationLoader;\n    this._operationExecutions = new Map();\n    this._network = this.__wrapNetworkWithLogObserver(config.network);\n    this._getDataID = (_config$getDataID = config.getDataID) !== null && _config$getDataID !== void 0 ? _config$getDataID : defaultGetDataID;\n    this._publishQueue = new RelayPublishQueue(config.store, (_config$handlerProvid = config.handlerProvider) !== null && _config$handlerProvid !== void 0 ? _config$handlerProvid : RelayDefaultHandlerProvider, this._getDataID);\n    this._scheduler = (_config$scheduler = config.scheduler) !== null && _config$scheduler !== void 0 ? _config$scheduler : null;\n    this._store = config.store;\n    this.options = config.options;\n    this._isServer = (_config$isServer = config.isServer) !== null && _config$isServer !== void 0 ? _config$isServer : false;\n\n    this.__setNet = function (newNet) {\n      return _this._network = _this.__wrapNetworkWithLogObserver(newNet);\n    };\n\n    if (process.env.NODE_ENV !== \"production\") {\n      var _require = require('./StoreInspector'),\n          inspect = _require.inspect;\n\n      this.DEBUG_inspect = function (dataID) {\n        return inspect(_this, dataID);\n      };\n    } // Register this Relay Environment with Relay DevTools if it exists.\n    // Note: this must always be the last step in the constructor.\n\n\n    var _global = typeof global !== 'undefined' ? global : typeof window !== 'undefined' ? window : undefined;\n\n    var devToolsHook = _global && _global.__RELAY_DEVTOOLS_HOOK__;\n\n    if (devToolsHook) {\n      devToolsHook.registerEnvironment(this);\n    }\n\n    this._missingFieldHandlers = config.missingFieldHandlers;\n    this._operationTracker = (_config$operationTrac = config.operationTracker) !== null && _config$operationTrac !== void 0 ? _config$operationTrac : new RelayOperationTracker();\n    this._reactFlightPayloadDeserializer = reactFlightPayloadDeserializer;\n    this._reactFlightServerErrorHandler = reactFlightServerErrorHandler;\n    this._shouldProcessClientComponents = config.shouldProcessClientComponents;\n  }\n\n  var _proto = RelayModernEnvironment.prototype;\n\n  _proto.getStore = function getStore() {\n    return this._store;\n  };\n\n  _proto.getNetwork = function getNetwork() {\n    return this._network;\n  };\n\n  _proto.getOperationTracker = function getOperationTracker() {\n    return this._operationTracker;\n  };\n\n  _proto.isRequestActive = function isRequestActive(requestIdentifier) {\n    var activeState = this._operationExecutions.get(requestIdentifier);\n\n    return activeState === 'active';\n  };\n\n  _proto.UNSTABLE_getDefaultRenderPolicy = function UNSTABLE_getDefaultRenderPolicy() {\n    return this._defaultRenderPolicy;\n  };\n\n  _proto.applyUpdate = function applyUpdate(optimisticUpdate) {\n    var _this2 = this;\n\n    var dispose = function dispose() {\n      _this2._scheduleUpdates(function () {\n        _this2._publishQueue.revertUpdate(optimisticUpdate);\n\n        _this2._publishQueue.run();\n      });\n    };\n\n    this._scheduleUpdates(function () {\n      _this2._publishQueue.applyUpdate(optimisticUpdate);\n\n      _this2._publishQueue.run();\n    });\n\n    return {\n      dispose: dispose\n    };\n  };\n\n  _proto.revertUpdate = function revertUpdate(update) {\n    var _this3 = this;\n\n    this._scheduleUpdates(function () {\n      _this3._publishQueue.revertUpdate(update);\n\n      _this3._publishQueue.run();\n    });\n  };\n\n  _proto.replaceUpdate = function replaceUpdate(update, newUpdate) {\n    var _this4 = this;\n\n    this._scheduleUpdates(function () {\n      _this4._publishQueue.revertUpdate(update);\n\n      _this4._publishQueue.applyUpdate(newUpdate);\n\n      _this4._publishQueue.run();\n    });\n  };\n\n  _proto.applyMutation = function applyMutation(optimisticConfig) {\n    var subscription = this._execute({\n      createSource: function createSource() {\n        return RelayObservable.create(function (_sink) {});\n      },\n      isClientPayload: false,\n      operation: optimisticConfig.operation,\n      optimisticConfig: optimisticConfig,\n      updater: null\n    }).subscribe({});\n\n    return {\n      dispose: function dispose() {\n        return subscription.unsubscribe();\n      }\n    };\n  };\n\n  _proto.check = function check(operation) {\n    if (this._missingFieldHandlers == null || this._missingFieldHandlers.length === 0) {\n      return this._store.check(operation);\n    }\n\n    return this._checkSelectorAndHandleMissingFields(operation, this._missingFieldHandlers);\n  };\n\n  _proto.commitPayload = function commitPayload(operation, payload) {\n    this._execute({\n      createSource: function createSource() {\n        return RelayObservable.from({\n          data: payload\n        });\n      },\n      isClientPayload: true,\n      operation: operation,\n      optimisticConfig: null,\n      updater: null\n    }).subscribe({});\n  };\n\n  _proto.commitUpdate = function commitUpdate(updater) {\n    var _this5 = this;\n\n    this._scheduleUpdates(function () {\n      _this5._publishQueue.commitUpdate(updater);\n\n      _this5._publishQueue.run();\n    });\n  };\n\n  _proto.lookup = function lookup(readSelector) {\n    return this._store.lookup(readSelector);\n  };\n\n  _proto.subscribe = function subscribe(snapshot, callback) {\n    return this._store.subscribe(snapshot, callback);\n  };\n\n  _proto.retain = function retain(operation) {\n    return this._store.retain(operation);\n  };\n\n  _proto.isServer = function isServer() {\n    return this._isServer;\n  };\n\n  _proto._checkSelectorAndHandleMissingFields = function _checkSelectorAndHandleMissingFields(operation, handlers) {\n    var _this6 = this;\n\n    var target = RelayRecordSource.create();\n\n    var result = this._store.check(operation, {\n      target: target,\n      handlers: handlers\n    });\n\n    if (target.size() > 0) {\n      this._scheduleUpdates(function () {\n        _this6._publishQueue.commitSource(target);\n\n        _this6._publishQueue.run();\n      });\n    }\n\n    return result;\n  };\n\n  _proto._scheduleUpdates = function _scheduleUpdates(task) {\n    var scheduler = this._scheduler;\n\n    if (scheduler != null) {\n      scheduler.schedule(task);\n    } else {\n      task();\n    }\n  }\n  /**\n   * Returns an Observable of GraphQLResponse resulting from executing the\n   * provided Query or Subscription operation, each result of which is then\n   * normalized and committed to the publish queue.\n   *\n   * Note: Observables are lazy, so calling this method will do nothing until\n   * the result is subscribed to: environment.execute({...}).subscribe({...}).\n   */\n  ;\n\n  _proto.execute = function execute(_ref) {\n    var _this7 = this;\n\n    var operation = _ref.operation,\n        updater = _ref.updater;\n    return this._execute({\n      createSource: function createSource() {\n        return _this7._network.execute(operation.request.node.params, operation.request.variables, operation.request.cacheConfig || {}, null);\n      },\n      isClientPayload: false,\n      operation: operation,\n      optimisticConfig: null,\n      updater: updater\n    });\n  }\n  /**\n   * Returns an Observable of GraphQLResponse resulting from executing the\n   * provided Mutation operation, the result of which is then normalized and\n   * committed to the publish queue along with an optional optimistic response\n   * or updater.\n   *\n   * Note: Observables are lazy, so calling this method will do nothing until\n   * the result is subscribed to:\n   * environment.executeMutation({...}).subscribe({...}).\n   */\n  ;\n\n  _proto.executeMutation = function executeMutation(_ref2) {\n    var _this8 = this;\n\n    var operation = _ref2.operation,\n        optimisticResponse = _ref2.optimisticResponse,\n        optimisticUpdater = _ref2.optimisticUpdater,\n        updater = _ref2.updater,\n        uploadables = _ref2.uploadables;\n    var optimisticConfig;\n\n    if (optimisticResponse || optimisticUpdater) {\n      optimisticConfig = {\n        operation: operation,\n        response: optimisticResponse,\n        updater: optimisticUpdater\n      };\n    }\n\n    return this._execute({\n      createSource: function createSource() {\n        return _this8._network.execute(operation.request.node.params, operation.request.variables, (0, _objectSpread2[\"default\"])((0, _objectSpread2[\"default\"])({}, operation.request.cacheConfig), {}, {\n          force: true\n        }), uploadables);\n      },\n      isClientPayload: false,\n      operation: operation,\n      optimisticConfig: optimisticConfig,\n      updater: updater\n    });\n  }\n  /**\n   * Returns an Observable of GraphQLResponse resulting from executing the\n   * provided Query or Subscription operation responses, the result of which is\n   * then normalized and comitted to the publish queue.\n   *\n   * Note: Observables are lazy, so calling this method will do nothing until\n   * the result is subscribed to:\n   * environment.executeWithSource({...}).subscribe({...}).\n   */\n  ;\n\n  _proto.executeWithSource = function executeWithSource(_ref3) {\n    var operation = _ref3.operation,\n        source = _ref3.source;\n    return this._execute({\n      createSource: function createSource() {\n        return source;\n      },\n      isClientPayload: false,\n      operation: operation,\n      optimisticConfig: null,\n      updater: null\n    });\n  };\n\n  _proto.toJSON = function toJSON() {\n    var _this$configName;\n\n    return \"RelayModernEnvironment(\".concat((_this$configName = this.configName) !== null && _this$configName !== void 0 ? _this$configName : '', \")\");\n  };\n\n  _proto._execute = function _execute(_ref4) {\n    var _this9 = this;\n\n    var createSource = _ref4.createSource,\n        isClientPayload = _ref4.isClientPayload,\n        operation = _ref4.operation,\n        optimisticConfig = _ref4.optimisticConfig,\n        updater = _ref4.updater;\n    return RelayObservable.create(function (sink) {\n      var executor = OperationExecutor.execute({\n        getDataID: _this9._getDataID,\n        isClientPayload: isClientPayload,\n        operation: operation,\n        operationExecutions: _this9._operationExecutions,\n        operationLoader: _this9._operationLoader,\n        operationTracker: _this9._operationTracker,\n        optimisticConfig: optimisticConfig,\n        publishQueue: _this9._publishQueue,\n        reactFlightPayloadDeserializer: _this9._reactFlightPayloadDeserializer,\n        reactFlightServerErrorHandler: _this9._reactFlightServerErrorHandler,\n        scheduler: _this9._scheduler,\n        shouldProcessClientComponents: _this9._shouldProcessClientComponents,\n        sink: sink,\n        // NOTE: Some product tests expect `Network.execute` to be called only\n        //       when the Observable is executed.\n        source: createSource(),\n        store: _this9._store,\n        treatMissingFieldsAsNull: _this9._treatMissingFieldsAsNull,\n        updater: updater\n      });\n      return function () {\n        return executor.cancel();\n      };\n    });\n  }\n  /**\n   * Wraps the network with logging to ensure that network requests are\n   * always logged. Relying on each network callsite to be wrapped is\n   * untenable and will eventually lead to holes in the logging.\n   */\n  ;\n\n  _proto.__wrapNetworkWithLogObserver = function __wrapNetworkWithLogObserver(network) {\n    var that = this;\n    return {\n      execute: function execute(params, variables, cacheConfig, uploadables) {\n        var transactionID = generateID();\n        var log = that.__log;\n        var logObserver = {\n          start: function start(subscription) {\n            log({\n              name: 'network.start',\n              transactionID: transactionID,\n              params: params,\n              variables: variables,\n              cacheConfig: cacheConfig\n            });\n          },\n          next: function next(response) {\n            log({\n              name: 'network.next',\n              transactionID: transactionID,\n              response: response\n            });\n          },\n          error: function error(_error) {\n            log({\n              name: 'network.error',\n              transactionID: transactionID,\n              error: _error\n            });\n          },\n          complete: function complete() {\n            log({\n              name: 'network.complete',\n              transactionID: transactionID\n            });\n          },\n          unsubscribe: function unsubscribe() {\n            log({\n              name: 'network.unsubscribe',\n              transactionID: transactionID\n            });\n          }\n        };\n\n        var logRequestInfo = function logRequestInfo(info) {\n          log({\n            name: 'network.info',\n            transactionID: transactionID,\n            info: info\n          });\n        };\n\n        return network.execute(params, variables, cacheConfig, uploadables, logRequestInfo)[\"do\"](logObserver);\n      }\n    };\n  };\n\n  return RelayModernEnvironment;\n}(); // Add a sigil for detection by `isRelayModernEnvironment()` to avoid a\n// realm-specific instanceof check, and to aid in module tree-shaking to\n// avoid requiring all of RelayRuntime just to detect its environment.\n\n\nRelayModernEnvironment.prototype['@@RelayModernEnvironment'] = true;\n\nfunction emptyFunction() {}\n\nmodule.exports = RelayModernEnvironment;","map":{"version":3,"sources":["/home/adamhanna/apps/relay-mongo-subscriptions-example/client/node_modules/relay-runtime/lib/store/RelayModernEnvironment.js"],"names":["_interopRequireDefault","require","_objectSpread2","OperationExecutor","RelayDefaultHandlerProvider","RelayFeatureFlags","RelayObservable","RelayOperationTracker","RelayPublishQueue","RelayRecordSource","defaultGetDataID","defaultRequiredFieldLogger","generateID","invariant","RelayModernEnvironment","config","_this","_config$log","_config$requiredField","_config$UNSTABLE_defa","_config$getDataID","_config$handlerProvid","_config$scheduler","_config$isServer","_config$operationTrac","configName","_treatMissingFieldsAsNull","treatMissingFieldsAsNull","operationLoader","reactFlightPayloadDeserializer","reactFlightServerErrorHandler","process","env","NODE_ENV","get","load","__log","log","emptyFunction","requiredFieldLogger","_defaultRenderPolicy","UNSTABLE_defaultRenderPolicy","ENABLE_PARTIAL_RENDERING_DEFAULT","_operationLoader","_operationExecutions","Map","_network","__wrapNetworkWithLogObserver","network","_getDataID","getDataID","_publishQueue","store","handlerProvider","_scheduler","scheduler","_store","options","_isServer","isServer","__setNet","newNet","_require","inspect","DEBUG_inspect","dataID","_global","global","window","undefined","devToolsHook","__RELAY_DEVTOOLS_HOOK__","registerEnvironment","_missingFieldHandlers","missingFieldHandlers","_operationTracker","operationTracker","_reactFlightPayloadDeserializer","_reactFlightServerErrorHandler","_shouldProcessClientComponents","shouldProcessClientComponents","_proto","prototype","getStore","getNetwork","getOperationTracker","isRequestActive","requestIdentifier","activeState","UNSTABLE_getDefaultRenderPolicy","applyUpdate","optimisticUpdate","_this2","dispose","_scheduleUpdates","revertUpdate","run","update","_this3","replaceUpdate","newUpdate","_this4","applyMutation","optimisticConfig","subscription","_execute","createSource","create","_sink","isClientPayload","operation","updater","subscribe","unsubscribe","check","length","_checkSelectorAndHandleMissingFields","commitPayload","payload","from","data","commitUpdate","_this5","lookup","readSelector","snapshot","callback","retain","handlers","_this6","target","result","size","commitSource","task","schedule","execute","_ref","_this7","request","node","params","variables","cacheConfig","executeMutation","_ref2","_this8","optimisticResponse","optimisticUpdater","uploadables","response","force","executeWithSource","_ref3","source","toJSON","_this$configName","concat","_ref4","_this9","sink","executor","operationExecutions","publishQueue","cancel","that","transactionID","logObserver","start","name","next","error","_error","complete","logRequestInfo","info","module","exports"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * \n * @emails oncall+relay\n * @format\n */\n// flowlint ambiguous-object-type:error\n'use strict';\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _objectSpread2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectSpread2\"));\n\nvar OperationExecutor = require('./OperationExecutor');\n\nvar RelayDefaultHandlerProvider = require('../handlers/RelayDefaultHandlerProvider');\n\nvar RelayFeatureFlags = require('../util/RelayFeatureFlags');\n\nvar RelayObservable = require('../network/RelayObservable');\n\nvar RelayOperationTracker = require('../store/RelayOperationTracker');\n\nvar RelayPublishQueue = require('./RelayPublishQueue');\n\nvar RelayRecordSource = require('./RelayRecordSource');\n\nvar defaultGetDataID = require('./defaultGetDataID');\n\nvar defaultRequiredFieldLogger = require('./defaultRequiredFieldLogger');\n\nvar generateID = require('../util/generateID');\n\nvar invariant = require('invariant');\n\nvar RelayModernEnvironment = /*#__PURE__*/function () {\n  function RelayModernEnvironment(config) {\n    var _this = this;\n\n    var _config$log, _config$requiredField, _config$UNSTABLE_defa, _config$getDataID, _config$handlerProvid, _config$scheduler, _config$isServer, _config$operationTrac;\n\n    this.configName = config.configName;\n    this._treatMissingFieldsAsNull = config.treatMissingFieldsAsNull === true;\n    var operationLoader = config.operationLoader;\n    var reactFlightPayloadDeserializer = config.reactFlightPayloadDeserializer;\n    var reactFlightServerErrorHandler = config.reactFlightServerErrorHandler;\n\n    if (process.env.NODE_ENV !== \"production\") {\n      if (operationLoader != null) {\n        !(typeof operationLoader === 'object' && typeof operationLoader.get === 'function' && typeof operationLoader.load === 'function') ? process.env.NODE_ENV !== \"production\" ? invariant(false, 'RelayModernEnvironment: Expected `operationLoader` to be an object ' + 'with get() and load() functions, got `%s`.', operationLoader) : invariant(false) : void 0;\n      }\n\n      if (reactFlightPayloadDeserializer != null) {\n        !(typeof reactFlightPayloadDeserializer === 'function') ? process.env.NODE_ENV !== \"production\" ? invariant(false, 'RelayModernEnvironment: Expected `reactFlightPayloadDeserializer` ' + ' to be a function, got `%s`.', reactFlightPayloadDeserializer) : invariant(false) : void 0;\n      }\n    }\n\n    this.__log = (_config$log = config.log) !== null && _config$log !== void 0 ? _config$log : emptyFunction;\n    this.requiredFieldLogger = (_config$requiredField = config.requiredFieldLogger) !== null && _config$requiredField !== void 0 ? _config$requiredField : defaultRequiredFieldLogger;\n    this._defaultRenderPolicy = ((_config$UNSTABLE_defa = config.UNSTABLE_defaultRenderPolicy) !== null && _config$UNSTABLE_defa !== void 0 ? _config$UNSTABLE_defa : RelayFeatureFlags.ENABLE_PARTIAL_RENDERING_DEFAULT === true) ? 'partial' : 'full';\n    this._operationLoader = operationLoader;\n    this._operationExecutions = new Map();\n    this._network = this.__wrapNetworkWithLogObserver(config.network);\n    this._getDataID = (_config$getDataID = config.getDataID) !== null && _config$getDataID !== void 0 ? _config$getDataID : defaultGetDataID;\n    this._publishQueue = new RelayPublishQueue(config.store, (_config$handlerProvid = config.handlerProvider) !== null && _config$handlerProvid !== void 0 ? _config$handlerProvid : RelayDefaultHandlerProvider, this._getDataID);\n    this._scheduler = (_config$scheduler = config.scheduler) !== null && _config$scheduler !== void 0 ? _config$scheduler : null;\n    this._store = config.store;\n    this.options = config.options;\n    this._isServer = (_config$isServer = config.isServer) !== null && _config$isServer !== void 0 ? _config$isServer : false;\n\n    this.__setNet = function (newNet) {\n      return _this._network = _this.__wrapNetworkWithLogObserver(newNet);\n    };\n\n    if (process.env.NODE_ENV !== \"production\") {\n      var _require = require('./StoreInspector'),\n          inspect = _require.inspect;\n\n      this.DEBUG_inspect = function (dataID) {\n        return inspect(_this, dataID);\n      };\n    } // Register this Relay Environment with Relay DevTools if it exists.\n    // Note: this must always be the last step in the constructor.\n\n\n    var _global = typeof global !== 'undefined' ? global : typeof window !== 'undefined' ? window : undefined;\n\n    var devToolsHook = _global && _global.__RELAY_DEVTOOLS_HOOK__;\n\n    if (devToolsHook) {\n      devToolsHook.registerEnvironment(this);\n    }\n\n    this._missingFieldHandlers = config.missingFieldHandlers;\n    this._operationTracker = (_config$operationTrac = config.operationTracker) !== null && _config$operationTrac !== void 0 ? _config$operationTrac : new RelayOperationTracker();\n    this._reactFlightPayloadDeserializer = reactFlightPayloadDeserializer;\n    this._reactFlightServerErrorHandler = reactFlightServerErrorHandler;\n    this._shouldProcessClientComponents = config.shouldProcessClientComponents;\n  }\n\n  var _proto = RelayModernEnvironment.prototype;\n\n  _proto.getStore = function getStore() {\n    return this._store;\n  };\n\n  _proto.getNetwork = function getNetwork() {\n    return this._network;\n  };\n\n  _proto.getOperationTracker = function getOperationTracker() {\n    return this._operationTracker;\n  };\n\n  _proto.isRequestActive = function isRequestActive(requestIdentifier) {\n    var activeState = this._operationExecutions.get(requestIdentifier);\n\n    return activeState === 'active';\n  };\n\n  _proto.UNSTABLE_getDefaultRenderPolicy = function UNSTABLE_getDefaultRenderPolicy() {\n    return this._defaultRenderPolicy;\n  };\n\n  _proto.applyUpdate = function applyUpdate(optimisticUpdate) {\n    var _this2 = this;\n\n    var dispose = function dispose() {\n      _this2._scheduleUpdates(function () {\n        _this2._publishQueue.revertUpdate(optimisticUpdate);\n\n        _this2._publishQueue.run();\n      });\n    };\n\n    this._scheduleUpdates(function () {\n      _this2._publishQueue.applyUpdate(optimisticUpdate);\n\n      _this2._publishQueue.run();\n    });\n\n    return {\n      dispose: dispose\n    };\n  };\n\n  _proto.revertUpdate = function revertUpdate(update) {\n    var _this3 = this;\n\n    this._scheduleUpdates(function () {\n      _this3._publishQueue.revertUpdate(update);\n\n      _this3._publishQueue.run();\n    });\n  };\n\n  _proto.replaceUpdate = function replaceUpdate(update, newUpdate) {\n    var _this4 = this;\n\n    this._scheduleUpdates(function () {\n      _this4._publishQueue.revertUpdate(update);\n\n      _this4._publishQueue.applyUpdate(newUpdate);\n\n      _this4._publishQueue.run();\n    });\n  };\n\n  _proto.applyMutation = function applyMutation(optimisticConfig) {\n    var subscription = this._execute({\n      createSource: function createSource() {\n        return RelayObservable.create(function (_sink) {});\n      },\n      isClientPayload: false,\n      operation: optimisticConfig.operation,\n      optimisticConfig: optimisticConfig,\n      updater: null\n    }).subscribe({});\n\n    return {\n      dispose: function dispose() {\n        return subscription.unsubscribe();\n      }\n    };\n  };\n\n  _proto.check = function check(operation) {\n    if (this._missingFieldHandlers == null || this._missingFieldHandlers.length === 0) {\n      return this._store.check(operation);\n    }\n\n    return this._checkSelectorAndHandleMissingFields(operation, this._missingFieldHandlers);\n  };\n\n  _proto.commitPayload = function commitPayload(operation, payload) {\n    this._execute({\n      createSource: function createSource() {\n        return RelayObservable.from({\n          data: payload\n        });\n      },\n      isClientPayload: true,\n      operation: operation,\n      optimisticConfig: null,\n      updater: null\n    }).subscribe({});\n  };\n\n  _proto.commitUpdate = function commitUpdate(updater) {\n    var _this5 = this;\n\n    this._scheduleUpdates(function () {\n      _this5._publishQueue.commitUpdate(updater);\n\n      _this5._publishQueue.run();\n    });\n  };\n\n  _proto.lookup = function lookup(readSelector) {\n    return this._store.lookup(readSelector);\n  };\n\n  _proto.subscribe = function subscribe(snapshot, callback) {\n    return this._store.subscribe(snapshot, callback);\n  };\n\n  _proto.retain = function retain(operation) {\n    return this._store.retain(operation);\n  };\n\n  _proto.isServer = function isServer() {\n    return this._isServer;\n  };\n\n  _proto._checkSelectorAndHandleMissingFields = function _checkSelectorAndHandleMissingFields(operation, handlers) {\n    var _this6 = this;\n\n    var target = RelayRecordSource.create();\n\n    var result = this._store.check(operation, {\n      target: target,\n      handlers: handlers\n    });\n\n    if (target.size() > 0) {\n      this._scheduleUpdates(function () {\n        _this6._publishQueue.commitSource(target);\n\n        _this6._publishQueue.run();\n      });\n    }\n\n    return result;\n  };\n\n  _proto._scheduleUpdates = function _scheduleUpdates(task) {\n    var scheduler = this._scheduler;\n\n    if (scheduler != null) {\n      scheduler.schedule(task);\n    } else {\n      task();\n    }\n  }\n  /**\n   * Returns an Observable of GraphQLResponse resulting from executing the\n   * provided Query or Subscription operation, each result of which is then\n   * normalized and committed to the publish queue.\n   *\n   * Note: Observables are lazy, so calling this method will do nothing until\n   * the result is subscribed to: environment.execute({...}).subscribe({...}).\n   */\n  ;\n\n  _proto.execute = function execute(_ref) {\n    var _this7 = this;\n\n    var operation = _ref.operation,\n        updater = _ref.updater;\n    return this._execute({\n      createSource: function createSource() {\n        return _this7._network.execute(operation.request.node.params, operation.request.variables, operation.request.cacheConfig || {}, null);\n      },\n      isClientPayload: false,\n      operation: operation,\n      optimisticConfig: null,\n      updater: updater\n    });\n  }\n  /**\n   * Returns an Observable of GraphQLResponse resulting from executing the\n   * provided Mutation operation, the result of which is then normalized and\n   * committed to the publish queue along with an optional optimistic response\n   * or updater.\n   *\n   * Note: Observables are lazy, so calling this method will do nothing until\n   * the result is subscribed to:\n   * environment.executeMutation({...}).subscribe({...}).\n   */\n  ;\n\n  _proto.executeMutation = function executeMutation(_ref2) {\n    var _this8 = this;\n\n    var operation = _ref2.operation,\n        optimisticResponse = _ref2.optimisticResponse,\n        optimisticUpdater = _ref2.optimisticUpdater,\n        updater = _ref2.updater,\n        uploadables = _ref2.uploadables;\n    var optimisticConfig;\n\n    if (optimisticResponse || optimisticUpdater) {\n      optimisticConfig = {\n        operation: operation,\n        response: optimisticResponse,\n        updater: optimisticUpdater\n      };\n    }\n\n    return this._execute({\n      createSource: function createSource() {\n        return _this8._network.execute(operation.request.node.params, operation.request.variables, (0, _objectSpread2[\"default\"])((0, _objectSpread2[\"default\"])({}, operation.request.cacheConfig), {}, {\n          force: true\n        }), uploadables);\n      },\n      isClientPayload: false,\n      operation: operation,\n      optimisticConfig: optimisticConfig,\n      updater: updater\n    });\n  }\n  /**\n   * Returns an Observable of GraphQLResponse resulting from executing the\n   * provided Query or Subscription operation responses, the result of which is\n   * then normalized and comitted to the publish queue.\n   *\n   * Note: Observables are lazy, so calling this method will do nothing until\n   * the result is subscribed to:\n   * environment.executeWithSource({...}).subscribe({...}).\n   */\n  ;\n\n  _proto.executeWithSource = function executeWithSource(_ref3) {\n    var operation = _ref3.operation,\n        source = _ref3.source;\n    return this._execute({\n      createSource: function createSource() {\n        return source;\n      },\n      isClientPayload: false,\n      operation: operation,\n      optimisticConfig: null,\n      updater: null\n    });\n  };\n\n  _proto.toJSON = function toJSON() {\n    var _this$configName;\n\n    return \"RelayModernEnvironment(\".concat((_this$configName = this.configName) !== null && _this$configName !== void 0 ? _this$configName : '', \")\");\n  };\n\n  _proto._execute = function _execute(_ref4) {\n    var _this9 = this;\n\n    var createSource = _ref4.createSource,\n        isClientPayload = _ref4.isClientPayload,\n        operation = _ref4.operation,\n        optimisticConfig = _ref4.optimisticConfig,\n        updater = _ref4.updater;\n    return RelayObservable.create(function (sink) {\n      var executor = OperationExecutor.execute({\n        getDataID: _this9._getDataID,\n        isClientPayload: isClientPayload,\n        operation: operation,\n        operationExecutions: _this9._operationExecutions,\n        operationLoader: _this9._operationLoader,\n        operationTracker: _this9._operationTracker,\n        optimisticConfig: optimisticConfig,\n        publishQueue: _this9._publishQueue,\n        reactFlightPayloadDeserializer: _this9._reactFlightPayloadDeserializer,\n        reactFlightServerErrorHandler: _this9._reactFlightServerErrorHandler,\n        scheduler: _this9._scheduler,\n        shouldProcessClientComponents: _this9._shouldProcessClientComponents,\n        sink: sink,\n        // NOTE: Some product tests expect `Network.execute` to be called only\n        //       when the Observable is executed.\n        source: createSource(),\n        store: _this9._store,\n        treatMissingFieldsAsNull: _this9._treatMissingFieldsAsNull,\n        updater: updater\n      });\n      return function () {\n        return executor.cancel();\n      };\n    });\n  }\n  /**\n   * Wraps the network with logging to ensure that network requests are\n   * always logged. Relying on each network callsite to be wrapped is\n   * untenable and will eventually lead to holes in the logging.\n   */\n  ;\n\n  _proto.__wrapNetworkWithLogObserver = function __wrapNetworkWithLogObserver(network) {\n    var that = this;\n    return {\n      execute: function execute(params, variables, cacheConfig, uploadables) {\n        var transactionID = generateID();\n        var log = that.__log;\n        var logObserver = {\n          start: function start(subscription) {\n            log({\n              name: 'network.start',\n              transactionID: transactionID,\n              params: params,\n              variables: variables,\n              cacheConfig: cacheConfig\n            });\n          },\n          next: function next(response) {\n            log({\n              name: 'network.next',\n              transactionID: transactionID,\n              response: response\n            });\n          },\n          error: function error(_error) {\n            log({\n              name: 'network.error',\n              transactionID: transactionID,\n              error: _error\n            });\n          },\n          complete: function complete() {\n            log({\n              name: 'network.complete',\n              transactionID: transactionID\n            });\n          },\n          unsubscribe: function unsubscribe() {\n            log({\n              name: 'network.unsubscribe',\n              transactionID: transactionID\n            });\n          }\n        };\n\n        var logRequestInfo = function logRequestInfo(info) {\n          log({\n            name: 'network.info',\n            transactionID: transactionID,\n            info: info\n          });\n        };\n\n        return network.execute(params, variables, cacheConfig, uploadables, logRequestInfo)[\"do\"](logObserver);\n      }\n    };\n  };\n\n  return RelayModernEnvironment;\n}(); // Add a sigil for detection by `isRelayModernEnvironment()` to avoid a\n// realm-specific instanceof check, and to aid in module tree-shaking to\n// avoid requiring all of RelayRuntime just to detect its environment.\n\n\nRelayModernEnvironment.prototype['@@RelayModernEnvironment'] = true;\n\nfunction emptyFunction() {}\n\nmodule.exports = RelayModernEnvironment;"]},"metadata":{},"sourceType":"script"}